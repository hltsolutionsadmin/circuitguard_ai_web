<div class="dashboard-wrapper">
  <!-- Dashboard List View -->
  <div class="dashboard-content" *ngIf="!detailFullPageOpen">
    <div class="flex justify-start items-center gap-4" style="padding: 1rem 4rem;">
       <h1 class="text-3xl">Incidents</h1>
    </div>
    <div class="space-y-6 bg-gray-50 min-h-screen" style="padding: 2em 5em;">
      <!-- Top Stat Cards -->
      <!-- Section Title & Filters -->
      <div class="flex flex-col sm:flex-row sm:items-center justify-between">
        <div>
          <h2 class="text-xl font-semibold text-gray-800">Incidents</h2>
          <p class="text-sm text-gray-500">Critical and high priority incidents requiring immediate attention</p>
        </div>

        <div class="flex items-center space-x-3 mt-3 sm:mt-0" *ngIf="!authService.devloper">
          <span class="text-sm text-gray-500 font-medium">View:</span>
          <button (click)="setPriorityFilter('ALL')" class="px-3 py-1 text-sm font-medium rounded-full transition-colors"
            [class.bg-blue-100]="selectedPriority === 'ALL'" [class.text-blue-600]="selectedPriority === 'ALL'"
            [class.text-gray-600]="selectedPriority !== 'ALL'" [class.hover:bg-gray-100]="selectedPriority !== 'ALL'">ALL</button>
          <button (click)="setPriorityFilter('LOW')" class="px-3 py-1 text-sm font-medium rounded-full transition-colors"
            [class.bg-blue-100]="selectedPriority === 'LOW'" [class.text-blue-600]="selectedPriority === 'LOW'"
            [class.text-gray-600]="selectedPriority !== 'LOW'" [class.hover:bg-gray-100]="selectedPriority !== 'LOW'">LOW</button>
          <button (click)="setPriorityFilter('MEDIUM')" class="px-3 py-1 text-sm font-medium rounded-full transition-colors"
            [class.bg-blue-100]="selectedPriority === 'MEDIUM'" [class.text-blue-600]="selectedPriority === 'MEDIUM'"
            [class.text-gray-600]="selectedPriority !== 'MEDIUM'" [class.hover:bg-gray-100]="selectedPriority !== 'MEDIUM'">MEDIUM</button>
          <button (click)="setPriorityFilter('HIGH')" class="px-3 py-1 text-sm font-medium rounded-full transition-colors"
            [class.bg-blue-100]="selectedPriority === 'HIGH'" [class.text-blue-600]="selectedPriority === 'HIGH'"
            [class.text-gray-600]="selectedPriority !== 'HIGH'" [class.hover:bg-gray-100]="selectedPriority !== 'HIGH'">HIGH</button>
        </div>
      </div>

      <!-- Loading/Error -->
      <div *ngIf="incidentsLoading" class="text-center py-8 text-gray-500">Loading incidents...</div>
      <div *ngIf="incidentsError && !incidentsLoading" class="text-center py-8 text-red-500">
        {{ incidentsError }}
        <button (click)="loadIncidents()" class="ml-2 text-blue-600 underline">Retry</button>
      </div>

      <!-- Table -->
      <div *ngIf="!incidentsLoading && !incidentsError" class="bg-white shadow rounded-2xl overflow-hidden">
        <table class="w-full text-left border-collapse">
          <thead class="bg-gray-100 text-sm text-gray-600">
            <tr>
              <th class="px-4 py-3 whitespace-nowrap"><input type="checkbox" /></th>
              <th class="px-4 py-3 whitespace-nowrap">Incident ID</th>
              <th class="px-4 py-3 whitespace-nowrap">Title</th>
              <th class="px-4 py-3 whitespace-nowrap">Priority</th>
              <th class="px-4 py-3 whitespace-nowrap">Status</th>
              <th class="px-4 py-3 whitespace-nowrap">Group</th>
              <th class="px-4 py-3 whitespace-nowrap">Created  By</th>
              <th class="px-4 py-3 whitespace-nowrap">Due Date</th>
            </tr>
          </thead>
          <tbody class="divide-y text-sm" *ngIf="incidents.length > 0; else noIncidents">
            <tr *ngFor="let incident of incidents; let i = index" class="hover:bg-gray-50">
              <td class="px-4 py-3"><input type="checkbox" /></td>
              <td class="px-4 py-3 font-mono text-gray-700">{{ incident.ticketId || incident.id }}</td>
              <td class="px-4 py-3 font-medium text-gray-800 cursor-pointer hoverTitle" (click)="openIncidentDetailsFullPage(incident)">
                <a>{{ incident.title }}</a>
              </td>
              <td class="px-4 py-3">
                <span [ngClass]="priorityClass(incident.priority)" class="px-2 py-1 text-xs font-medium rounded-full">{{ incident.priority }}</span>
              </td>
              <td class="px-4 py-3 whitespace-nowrap">
                <span [ngClass]="statusClass(incident.status)" class="px-2 py-1 text-xs font-medium rounded-full">{{ incident.status.replace('_', ' ') }}</span>
              </td>
              <td class="px-4 py-3 text-center"><span class="text-sm text-gray-600 whitespace-nowrap">{{ incident.subCategoryName || '-'}}</span></td>
              <td class="px-4 py-3 text-gray-600">{{ incident.createdByName }}</td>
              <td class="px-4 py-3 font-medium whitespace-nowrap" [ngClass]="incident.dueOverdue ? 'text-red-500' : 'text-green-500'">
                {{ incident.dueDate }}
                <!-- <span *ngIf="incident.dueOverdue" class="text-xs">(Overdue)</span> -->
                <span *ngIf="!incident.dueOverdue && incident.completed" class="text-xs">(Completed)</span>
              </td>
            </tr>
          </tbody>
        </table>

        <ng-template #noIncidents>
          <tbody><tr><td colspan="8" class="text-center py-8 text-gray-500">No incidents found.</td></tr></tbody>
        </ng-template>

        <!-- Pagination -->
        <div class="flex items-center justify-between p-4 border-t text-sm text-gray-600">
          <p>Showing {{ incidents.length }} of {{ totalElements }} incidents</p>
          <div class="flex items-center space-x-2">
            <button (click)="onPageChange(pageNumber - 1)" [disabled]="pageNumber === 0"
              class="px-3 py-1 border rounded hover:bg-gray-100 disabled:opacity-50 disabled:cursor-not-allowed">Previous</button>
            <button *ngFor="let p of [].constructor(totalPages); let i = index" (click)="onPageChange(i)"
              [class.bg-blue-100]="i === pageNumber" [class.text-blue-600]="i === pageNumber"
              class="px-3 py-1 border rounded hover:bg-gray-100">{{ i + 1 }}</button>
            <button (click)="onPageChange(pageNumber + 1)" [disabled]="pageNumber >= totalPages - 1"
              class="px-3 py-1 border rounded hover:bg-gray-100 disabled:opacity-50 disabled:cursor-not-allowed">Next</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Full-Page Detail View -->
  <div *ngIf="detailFullPageOpen" class="w-full inset-0 bg-white z-50 overflow-y-auto">
    <div class="min-h-screen flex flex-col">
      <!-- Sticky Header -->
      <div class="sticky top-0 bg-white border-b border-gray-200 shadow-sm p-4 flex justify-between items-center z-10">
        <button (click)="closeIncidentDetails()" class="flex items-center space-x-2 text-gray-600 hover:text-gray-800">
          <mat-icon class="cursor-pointer">arrow_back</mat-icon>
          <span class="text-lg font-medium">Back to Incidents</span>
        </button>
        <button (click)="closeIncidentDetails()" class="text-gray-500 hover:text-gray-700 p-1 rounded-full hover:bg-gray-100">
          <!-- <mat-icon>close</mat-icon> -->
        </button>
      </div>

      <!-- Detail Component (full width/height) -->
      <app-incident-detail-panel-component
        [incident]="selectedIncident!"
        [MembersList]="projectAssignedMembers!"
        (commentsUpdated)="refreshIncident($event)"
        (closed)="closeIncidentDetails()">
      </app-incident-detail-panel-component>
    </div>
  </div>
</div>